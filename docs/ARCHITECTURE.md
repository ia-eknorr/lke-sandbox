# LKE Sandbox Architecture Reference

Technical reference for the LKE Sandbox platform architecture.

## System Overview

LKE Sandbox implements a **Secrets-First GitOps** pattern on Linode Kubernetes Engine. The platform deploys the secrets pipeline before the GitOps controller to break circular dependencies.

**Domain**: `*.sandbox.knorr.casa`
**Region**: us-west
**Kubernetes**: 1.34
**Nodes**: 2x g6-standard-2 (4GB RAM each)

## Three-Layer Architecture

| Layer | Tooling | Lifecycle | Contents |
|-------|---------|-----------|----------|
| **1. Infrastructure** | OpenTofu | Rarely changes | LKE cluster, Cloud Firewall, node pools |
| **2. Bootstrap** | Helmfile | Manual, infrequent | PGO → Infisical → External Secrets → ArgoCD |
| **3. Workloads** | ArgoCD | Automated, frequent | cert-manager, Traefik, Keycloak, applications |

### Bootstrap Dependency Chain

```
PGO (database) → Infisical (secrets UI) → External Secrets (K8s sync) → ArgoCD (GitOps)
```

ArgoCD then manages Layer 3 services via sync waves:
- **Wave 0**: cert-manager
- **Wave 1**: Traefik, trust-manager
- **Wave 2**: Keycloak

## Component Summary

| Component | Version | Namespace | Purpose |
|-----------|---------|-----------|---------|
| **PGO** | 5.8.2 | pgo | PostgreSQL operator for Infisical/Keycloak databases |
| **Infisical** | 0.154.6 | infisical | Self-hosted secrets management platform |
| **External Secrets** | 1.2.0 | external-secrets | Syncs Infisical secrets to K8s Secrets |
| **ArgoCD** | 2.10.0 | argocd | GitOps controller with OIDC auth |
| **cert-manager** | 1.19.2 | cert-manager | TLS certificates via Let's Encrypt DNS-01 |
| **Traefik** | 3.6.5 | traefik | Gateway API ingress controller |
| **Keycloak** | latest | keycloak | OIDC identity provider for ArgoCD |
| **trust-manager** | latest | cert-manager | CA certificate distribution |

## Network Architecture

### External Access

| Service | Hostname | Port |
|---------|----------|------|
| ArgoCD | argocd.sandbox.knorr.casa | 443 |
| Infisical | infisical.sandbox.knorr.casa | 443 |
| Keycloak | keycloak.sandbox.knorr.casa | 443 |
| Applications | *.sandbox.knorr.casa | 443 |

### Internal Services

| Service | Endpoint | Notes |
|---------|----------|-------|
| PostgreSQL Primary | pgo-primary.pgo.svc:5432 | Direct connection (not PgBouncer) |
| PgBouncer | pgo-pgbouncer.pgo.svc:5432 | Connection pooling |
| Infisical Backend | infisical-backend.infisical.svc:8080 | API server |
| Traefik Gateway | traefik.traefik.svc:443 | Gateway API controller |

### Firewall Rules

Linode Cloud Firewall with drop-by-default inbound policy:

| Rule | Ports | Source | Purpose |
|------|-------|--------|---------|
| HTTPS | 443 | 0.0.0.0/0 | Web traffic |
| HTTP | 80 | 0.0.0.0/0 | Redirect to HTTPS |
| K8s API | 6443 | 0.0.0.0/0 | kubectl access |
| NodePort | 30000-32767 | 0.0.0.0/0 | NodePort services |
| Kubelet | 10250 | Internal | Health checks |
| Webhooks | 8443, 9443, 10260 | Internal | Admission controllers |

## Secrets Flow

### Manual Secrets (Bootstrap)

1. **Cloudflare API Token** → Stored in Infisical → Synced to cert-manager namespace
2. **Machine Identity** → Created in Infisical UI → Stored in K8s secret manually

### Automatic Secrets

1. **PostgreSQL credentials** → Generated by PGO → Synced via ESO Kubernetes provider
2. **Keycloak DB** → PGO generates `pgo-pguser-keycloak` → Used by Keycloak pods
3. **Infisical DB** → PGO generates `pgo-pguser-infisical` → Used by Infisical pods

### Secret Sync Pattern

```
Infisical Project → ClusterSecretStore → ExternalSecret → K8s Secret → Application
```

The ClusterSecretStore uses Machine Identity authentication with `clientId` and `clientSecret`.

## Gateway API Pattern

All ingress uses Gateway API (not Ingress resources):

**Gateway** (infrastructure team owns):
- Name: `traefik-gateway`
- Namespace: `traefik`
- TLS: References `sandbox-wildcard` certificate

**HTTPRoute** (application team owns):
- References `traefik-gateway` via `parentRefs`
- Defines hostname matching
- Routes to backend services

Cross-namespace routing is enabled, allowing applications in any namespace to use the shared gateway.

## Database Architecture

PostgresCluster `mgmt` in `pgo` namespace provides:

| User | Database | Consumer |
|------|----------|----------|
| infisical | infisical | Infisical backend |
| keycloak | keycloak | Keycloak identity server |

**Note**: Infisical connects directly to `pgo-primary.pgo.svc` instead of PgBouncer to avoid read-replica routing issues.

## TLS Certificate Chain

1. **ClusterIssuer** `letsencrypt-prod` configured with Cloudflare DNS-01
2. **Certificate** `sandbox-wildcard` requests `*.sandbox.knorr.casa`
3. cert-manager creates TXT record in Cloudflare for validation
4. Certificate stored in `sandbox-wildcard-tls` Secret in traefik namespace
5. Traefik Gateway references this secret for TLS termination

## Authentication

| Service | Method | Provider |
|---------|--------|----------|
| ArgoCD | OIDC | Keycloak (realm: sandbox, client: argocd) |
| Infisical | Local | Email/password (admin@knorr.casa) |
| Kubernetes | Bearer token | kubeconfig from OpenTofu |
| Traefik Dashboard | None | Internal access only |

## Design Decisions

### Why Secrets-First GitOps?

ArgoCD needs secrets to clone repos, but External Secrets must be deployed to provide secrets. Solution: manually deploy the secrets pipeline (PGO → Infisical → ESO) before ArgoCD, then let ArgoCD manage everything else.

### Why Gateway API over Ingress?

- Better role separation (Gateway vs HTTPRoute)
- First-class cross-namespace support
- Standardized header/path matching
- Active development vs Ingress maintenance mode

### Why Infisical over Vault?

- Lower complexity and resource usage
- Developer-friendly UI
- Good External Secrets Operator support
- Sufficient for application secrets (not PKI/encryption)

### Why Direct PostgreSQL Connection?

PGO's PgBouncer routes to read replicas by default, causing "read-only transaction" errors for writes. Infisical connects directly to `pgo-primary.pgo.svc` to ensure all queries go to the primary.

## Related Documentation

- [Golden Pathway](GOLDEN-PATHWAY.md) - Three-layer philosophy
- [Bootstrap Guide](BOOTSTRAP.md) - Deployment walkthrough
- [Configuration Reference](CONFIGURATION.md) - Variables and options
- [Operations Guide](OPERATIONS.md) - Day-2 operations