apiVersion: postgres-operator.crunchydata.com/v1beta1
kind: PostgresCluster
metadata:
  annotations:
    argocd.argoproj.io/sync-wave: "1"
    postgres-operator.crunchydata.com/autoCreateUserSchema: "true"
  name: pgo
spec:
  backups:
    pgbackrest:
      global:
        repo1-retention-full: "14"
        repo1-retention-full-type: time
      manual:
        options:
        - --type=full
        repoName: repo1
      repos:
      - name: repo1
        schedules:
          differential: 0 1 * * 1-6
          full: 0 1 * * 0
        volume:
          volumeClaimSpec:
            accessModes:
            - ReadWriteOnce
            resources:
              requests:
                storage: 20Gi
            storageClassName: linode-block-storage-retain
  instances:
  - affinity:
      podAntiAffinity:
        requiredDuringSchedulingIgnoredDuringExecution:
        - labelSelector:
            matchLabels:
              postgres-operator.crunchydata.com/cluster: pgo
              postgres-operator.crunchydata.com/instance-set: instance1
          topologyKey: topology.kubernetes.io/zone
    dataVolumeClaimSpec:
      accessModes:
      - ReadWriteOnce
      resources:
        requests:
          storage: 3Gi
      storageClassName: linode-block-storage-retain
    name: instance1
    replicas: 2
    walVolumeClaimSpec:
      accessModes:
      - ReadWriteOnce
      resources:
        requests:
          storage: 3Gi
      storageClassName: linode-block-storage-retain
  port: 5432
  postgresVersion: 16
  proxy:
    pgBouncer:
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - podAffinityTerm:
              labelSelector:
                matchLabels:
                  postgres-operator.crunchydata.com/cluster: pgo
                  postgres-operator.crunchydata.com/role: pgbouncer
              topologyKey: topology.kubernetes.io/zone
            weight: 1
      port: 5432
      replicas: 2
  users:
  - databases:
    - keycloak
    name: keycloak
  - databases:
    - infisical
    name: infisical
