# Infisical self-hosted configuration
# The infisical-secrets secret is auto-generated by templates/secrets.yaml
# using Helm lookup to preserve values across upgrades

upstream:
  postgresql:
    enabled: false  # Use PGO cluster

  redis:
    enabled: true
    auth:
      password: "infisical-redis-password"
    architecture: standalone

  ingress:
    enabled: false  # Use Gateway API HTTPRoute
    nginx:
      enabled: false

  # App configuration (nested under 'infisical' key in upstream chart)
  infisical:
    kubeSecretRef: "infisical-secrets"
    replicaCount: 1
    image:
      tag: "v0.154.6"

    # Creates admin user and org automatically, skipping setup wizard
    autoBootstrap:
      enabled: true
      organization: "Knorr"
      # Bootstrap output for provision-eso job (must be single-line JSON)
      secretTemplate: '{"data":{"token":"{{ .Identity.Credentials.Token }}","organizationId":"{{ .Organization.ID }}","organizationSlug":"{{ .Organization.Slug }}","adminEmail":"{{ .User.Email }}","identityId":"{{ .Identity.ID }}"}}'
      secretDestination:
        name: infisical-bootstrap-output
        namespace: infisical
      credentialSecret:
        name: infisical-bootstrap-credentials

bootstrap:
  adminEmail: ""
  adminPassword: ""

httpRoute:
  enabled: true
  hostname: ""
  gateway:
    name: traefik-gateway
    namespace: traefik
  service:
    name: infisical-upstream
    port: 8080

# Secrets injected by helmfile via readFile, uploaded to Infisical by provision-eso job
bootstrapSecrets:
  cloudflareApiToken: ""
