# Infisical self-hosted configuration
# Requires: PostgreSQL (via PGO), Redis
#
# The infisical-secrets secret is auto-generated by templates/secrets.yaml
# using Helm lookup to preserve values across upgrades

# Upstream infisical-standalone chart values
# Values are split between root level (for subchart dependencies) and
# 'infisical' key (for the app itself)
upstream:
  # Subchart dependency controls (at ROOT of upstream chart)
  # These disable/enable bundled dependencies via Chart.yaml conditions
  postgresql:
    enabled: false  # Use external PGO cluster instead of bundled Bitnami PostgreSQL

  redis:
    enabled: true  # Use bundled Redis for sandbox
    auth:
      password: "infisical-redis-password"
    architecture: standalone

  ingress:
    enabled: false  # Use Traefik Gateway API instead (HTTPRoute)
    nginx:
      enabled: false  # Don't deploy bundled ingress-nginx controller

  # Infisical app configuration (nested under 'infisical' key)
  # Templates access these via .Values.infisical.*
  infisical:
    # Reference to auto-generated secret containing ENCRYPTION_KEY, AUTH_SECRET, etc.
    kubeSecretRef: "infisical-secrets"

    # Single replica for sandbox
    replicaCount: 1

    image:
      tag: "v0.154.6"

    # Auto-bootstrap: creates admin user and org automatically
    # Skips the setup wizard - you still need to create Machine Identity manually
    autoBootstrap:
      enabled: true
      organization: "Knorr"
      # Store bootstrap token for provision-eso job
      # Must be single-line JSON since it's passed as CLI arg to infisical bootstrap
      secretTemplate: '{"data":{"token":"{{ .Identity.Credentials.Token }}","organizationId":"{{ .Organization.ID }}","organizationSlug":"{{ .Organization.Slug }}","adminEmail":"{{ .User.Email }}","identityId":"{{ .Identity.ID }}"}}'
      secretDestination:
        name: infisical-bootstrap-output
        namespace: infisical
      # Reference to secret with INFISICAL_ADMIN_EMAIL and INFISICAL_ADMIN_PASSWORD
      credentialSecret:
        name: infisical-bootstrap-credentials

# Bootstrap admin credentials (set in environment values)
bootstrap:
  adminEmail: ""
  adminPassword: ""

# HTTPRoute configuration (Gateway API)
httpRoute:
  enabled: true
  hostname: ""  # Set in environment values, e.g., infisical.sandbox.knorr.casa
  gateway:
    name: traefik-gateway
    namespace: traefik
  service:
    name: infisical
    port: 8080

# Bootstrap secrets to upload to Infisical project
# Values are injected by helmfile via readFile from bootstrap/secrets/
# The provision-eso job uploads these to Infisical after project creation
bootstrapSecrets:
  cloudflareApiToken: ""  # Populated by helmfile readFile
