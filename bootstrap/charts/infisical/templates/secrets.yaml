{{/*
Bootstrap secret for Infisical
Uses lookup to preserve existing secrets across upgrades
Generates new values only on first install
*/}}
{{- $secretName := "infisical-secrets" }}
{{- $namespace := .Release.Namespace }}

{{/* Lookup existing secret */}}
{{- $existingSecret := lookup "v1" "Secret" $namespace $secretName }}

{{/* Get DB connection from PGO secret via PgBouncer */}}
{{/* Uses sslmode=require for TLS-secured PgBouncer connections */}}
{{- $pgoSecret := lookup "v1" "Secret" "pgo" "pgo-pguser-infisical" }}
{{- $dbUri := "" }}
{{- if $pgoSecret }}
  {{- $rawUri := index $pgoSecret.data "pgbouncer-uri" | b64dec }}
  {{- $dbUri = printf "%s?sslmode=require" $rawUri }}
{{- end }}

{{/* Determine values: use existing or generate new */}}
{{- $encryptionKey := "" }}
{{- $authSecret := "" }}
{{- if $existingSecret }}
  {{/* Preserve existing values */}}
  {{- $encryptionKey = index $existingSecret.data "ENCRYPTION_KEY" | b64dec }}
  {{- $authSecret = index $existingSecret.data "AUTH_SECRET" | b64dec }}
{{- else }}
  {{/* Generate new values (first install only) */}}
  {{- $encryptionKey = randAlphaNum 32 }}
  {{- $authSecret = randAlphaNum 32 }}
{{- end }}

apiVersion: v1
kind: Secret
metadata:
  name: {{ $secretName }}
  namespace: {{ $namespace }}
  labels:
    {{- include "infisical.labels" . | nindent 4 }}
  annotations:
    helm.sh/resource-policy: keep
type: Opaque
stringData:
  ENCRYPTION_KEY: {{ $encryptionKey | quote }}
  AUTH_SECRET: {{ $authSecret | quote }}
  {{- if $dbUri }}
  DB_CONNECTION_URI: {{ $dbUri | quote }}
  {{- else }}
  # WARNING: PGO secret not found - deploy PGO first
  DB_CONNECTION_URI: "postgresql://infisical:CHANGE_ME@pgo-pgbouncer.pgo.svc:5432/infisical?sslmode=require"
  {{- end }}
  SITE_URL: "https://{{ .Values.httpRoute.hostname }}"
  REDIS_URL: "redis://:infisical-redis-password@{{ .Release.Name }}-redis-master:6379"
  # Disable TLS certificate verification for PGO's self-signed CA (sandbox only)
  NODE_TLS_REJECT_UNAUTHORIZED: "0"
