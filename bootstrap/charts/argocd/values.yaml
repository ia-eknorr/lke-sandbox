argo-cd:
  global:
    domain: argocd.sandbox.knorr.casa

  configs:
    params:
      server.insecure: true  # TLS terminated at gateway

    cm:
      url: https://argocd.sandbox.knorr.casa

      # Enable Helm value files from outside chart directory
      helm.valuesFileSchemes: >-
        secrets+gpg-import, secrets+gpg-import-kubernetes,
        secrets+age-import, secrets+age-import-kubernetes,
        secrets, secrets+literal,
        https, file

      # Client secret pulled via ExternalSecret from Infisical
      oidc.config: |
        name: Keycloak
        issuer: https://keycloak.sandbox.knorr.casa/realms/sandbox
        clientID: argocd
        clientSecret: $oidc.keycloak.clientSecret
        requestedScopes:
          - openid
          - profile
          - email
          - groups

    rbac:
      # Map Keycloak groups to ArgoCD roles
      policy.csv: |
        g, admin, role:admin
        g, developers, role:readonly
      policy.default: role:readonly

  server:
    ingress:
      enabled: false  # Use HTTPRoute

    certificate:
      enabled: false  # Using wildcard via Gateway

  dex:
    enabled: false  # Using Keycloak

httpRoute:
  enabled: true
  hostname: ""
  gateway:
    name: traefik-gateway
    namespace: traefik
  service:
    name: argocd-server
    port: 80

oidc:
  enabled: true
  secretStore:
    name: infisical
    kind: ClusterSecretStore
  infisicalSecretKey: argocd-oidc-client-secret

repoCredentials:
  enabled: false

appOfApps:
  enabled: true
  repoURL: "https://github.com/ia-eknorr/lke-sandbox.git"
  targetRevision: "main"
