{{- if .Values.realmImport.enabled }}
{{- /*
  Lookup secrets at Helm render time for direct substitution.
  This avoids relying on Keycloak's placeholder substitution which requires
  -Dkeycloak.migration.replace-placeholders=true (not enabled by operator).

  Passwords are stored in keycloak-user-passwords secret - retrieve with:
    kubectl get secret keycloak-user-passwords -n keycloak -o jsonpath='{.data.admin-password}' | base64 -d
*/ -}}
{{- $clientSecrets := lookup "v1" "Secret" .Release.Namespace "keycloak-client-secrets" }}
{{- $userPasswords := lookup "v1" "Secret" .Release.Namespace "keycloak-user-passwords" }}
apiVersion: k8s.keycloak.org/v2alpha1
kind: KeycloakRealmImport
metadata:
  name: sandbox-realm
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "keycloak.labels" . | nindent 4 }}
  annotations:
    argocd.argoproj.io/sync-wave: "2"
spec:
  keycloakCRName: keycloak
  realm:
    realm: {{ .Values.realmImport.realmName }}
    enabled: true
    displayName: {{ .Values.realmImport.displayName | default "Sandbox Realm" }}

    # Groups scope for ArgoCD RBAC
    clientScopes:
      - name: groups
        protocol: openid-connect
        attributes:
          include.in.token.scope: "true"
          display.on.consent.screen: "false"
        protocolMappers:
          - name: groups
            protocol: openid-connect
            protocolMapper: oidc-group-membership-mapper
            config:
              claim.name: groups
              full.path: "false"
              id.token.claim: "true"
              access.token.claim: "true"
              userinfo.token.claim: "true"

    # Groups for RBAC
    groups:
      - name: admin
      - name: developers

    # ArgoCD OIDC Client
    clients:
      - clientId: argocd
        name: ArgoCD
        enabled: true
        publicClient: false
        clientAuthenticatorType: client-secret
        {{- if $clientSecrets }}
        secret: {{ index $clientSecrets.data "argocd-client-secret" | b64dec | quote }}
        {{- else }}
        # Fallback: secrets not yet created (first install) - will be updated on next sync
        secret: {{ randAlphaNum 32 | quote }}
        {{- end }}
        redirectUris:
          - "https://argocd.{{ .Values.realmImport.domain }}/auth/callback"
        webOrigins:
          - "https://argocd.{{ .Values.realmImport.domain }}"
        standardFlowEnabled: true
        directAccessGrantsEnabled: false
        # Only reference our custom 'groups' scope - Keycloak adds default OIDC scopes automatically
        defaultClientScopes:
          - groups

    # Users with temporary passwords (substituted at Helm render time)
    # Retrieve passwords: kubectl get secret keycloak-user-passwords -n keycloak -o jsonpath='{.data.admin-password}' | base64 -d
    users:
      - username: admin
        email: admin@{{ .Values.realmImport.domain }}
        firstName: Admin
        lastName: User
        enabled: true
        emailVerified: true
        groups:
          - admin
        credentials:
          - type: password
            {{- if $userPasswords }}
            value: {{ index $userPasswords.data "admin-password" | b64dec | quote }}
            {{- else }}
            # Fallback: random password for first install - check keycloak-user-passwords secret after sync
            value: {{ randAlphaNum 16 | quote }}
            {{- end }}
            temporary: true

      - username: developer
        email: developer@{{ .Values.realmImport.domain }}
        firstName: Developer
        lastName: User
        enabled: true
        emailVerified: true
        groups:
          - developers
        credentials:
          - type: password
            {{- if $userPasswords }}
            value: {{ index $userPasswords.data "developer-password" | b64dec | quote }}
            {{- else }}
            # Fallback: random password for first install - check keycloak-user-passwords secret after sync
            value: {{ randAlphaNum 16 | quote }}
            {{- end }}
            temporary: true
{{- end }}
