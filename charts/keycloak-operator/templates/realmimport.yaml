{{- if .Values.realmImport.enabled }}
apiVersion: k8s.keycloak.org/v2alpha1
kind: KeycloakRealmImport
metadata:
  name: sandbox-realm
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "keycloak.labels" . | nindent 4 }}
  annotations:
    argocd.argoproj.io/sync-wave: "2"
spec:
  keycloakCRName: keycloak
  realm:
    realm: {{ .Values.realmImport.realmName }}
    enabled: true
    displayName: {{ .Values.realmImport.displayName | default "Sandbox Realm" }}

    # Groups scope for ArgoCD RBAC
    clientScopes:
      - name: groups
        protocol: openid-connect
        attributes:
          include.in.token.scope: "true"
          display.on.consent.screen: "false"
        protocolMappers:
          - name: groups
            protocol: openid-connect
            protocolMapper: oidc-group-membership-mapper
            config:
              claim.name: groups
              full.path: "false"
              id.token.claim: "true"
              access.token.claim: "true"
              userinfo.token.claim: "true"

    # Groups for RBAC
    groups:
      - name: admin
      - name: developers

    # ArgoCD OIDC Client
    clients:
      - clientId: argocd
        name: ArgoCD
        enabled: true
        publicClient: false
        clientAuthenticatorType: client-secret
        secret: "${ARGOCD_CLIENT_SECRET}"
        redirectUris:
          - "https://argocd.{{ .Values.realmImport.domain }}/auth/callback"
        webOrigins:
          - "https://argocd.{{ .Values.realmImport.domain }}"
        standardFlowEnabled: true
        directAccessGrantsEnabled: false
        defaultClientScopes:
          - openid
          - profile
          - email
          - groups

    # Users with temporary passwords
    users:
      - username: admin
        email: admin@{{ .Values.realmImport.domain }}
        firstName: Admin
        lastName: User
        enabled: true
        emailVerified: true
        groups:
          - admin
        credentials:
          - type: password
            value: "${ADMIN_TEMP_PASSWORD}"
            temporary: true

      - username: developer
        email: developer@{{ .Values.realmImport.domain }}
        firstName: Developer
        lastName: User
        enabled: true
        emailVerified: true
        groups:
          - developers
        credentials:
          - type: password
            value: "${DEV_TEMP_PASSWORD}"
            temporary: true

  # Placeholder substitution from Secrets
  placeholders:
    ARGOCD_CLIENT_SECRET:
      secret:
        name: keycloak-client-secrets
        key: argocd-client-secret
    ADMIN_TEMP_PASSWORD:
      secret:
        name: keycloak-user-passwords
        key: admin-password
    DEV_TEMP_PASSWORD:
      secret:
        name: keycloak-user-passwords
        key: developer-password
{{- end }}
